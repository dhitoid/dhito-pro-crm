<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Follow Up â€“ Dhito Pro CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/ui.css">
</head>

<body class="dark">

<script src="js/auth.js"></script>
<script>protect()</script>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">DHITO<br>CRM</div>

    <a href="dashboard.html">
      <span>ğŸ </span> Home
    </a>

    <a href="leads.html">
      <span>ğŸ“‡</span> Leads
    </a>

    <a href="followup.html" class="active">
      <span>ğŸ””</span> Follow
    </a>

    <div style="margin-top:auto;width:100%">
      <a href="#" onclick="logout()">
        <span>ğŸšª</span> Logout
      </a>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="container">

      <h2>Follow Up Konsumen</h2>

      <!-- FORM -->
      <div class="card">
        <h3>ğŸ“ Update Follow Up</h3>

        <label>Status Konsumen</label>
        <select id="status"></select>

        <label>Tanggal Follow Up Berikutnya</label>
        <input type="date" id="next">

        <label>Catatan Follow Up</label>
        <textarea id="note" placeholder="Tulis hasil follow up, respon konsumen, dll..."></textarea>

        <button onclick="simpan()">Simpan Follow Up</button>
      </div>

      <!-- HISTORY -->
      <div class="card">
        <h3>ğŸ“œ Riwayat Follow Up</h3>
        <ul id="history" class="timeline"></ul>
      </div>

    </div>
  </main>

</div>

<script src="js/db.js"></script>
<script src="js/pipeline.js"></script>

<script>
const id = Number(new URLSearchParams(location.search).get("id"));

function renderStatus(selected){
  status.innerHTML = "";
  STATUS_LIST.forEach(s=>{
    status.innerHTML += `
      <option value="${s}" ${s===selected?"selected":""}>${s}</option>
    `;
  });
}

function load(){
  getLeads(data=>{
    const d = data.find(x=>x.id===id);
    if(!d) return;

    renderStatus(normalizeStatus(d.status));
    next.value = d.nextFollow || "";
    history.innerHTML = "";

    if(d.catatan.length === 0){
      history.innerHTML = "<li><i>Belum ada catatan</i></li>";
    }

    d.catatan.slice().reverse().forEach(c=>{
      history.innerHTML += `
        <li>
          <small>${c.tgl}</small><br>
          ${c.text}
        </li>
      `;
    });
  });
}

function simpan(){
  if(!status.value){
    alert("Pilih status");
    return;
  }

  const tx = db.transaction("leads","readwrite");
  const store = tx.objectStore("leads");
  const req = store.get(id);

  req.onsuccess = ()=>{
    const d = req.result;
    d.status = normalizeStatus(status.value);
    d.nextFollow = next.value;

    if(note.value){
      d.catatan.push({
        tgl: new Date().toLocaleString(),
        text: note.value
      });
    }

    store.put(d);
    note.value = "";
    load();
  };
}

document.addEventListener("DOMContentLoaded", ()=>{
  const wait = setInterval(()=>{
    if(window.db){
      clearInterval(wait);
      load();
    }
  },100);
});
</script>

</body>
</html>
