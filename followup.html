<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Follow Up - Dhito Pro CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>
<body class="dark">

<script src="js/auth.js"></script>
<script>protect()</script>

<h2>Follow Up Konsumen</h2>

<select id="status">
  <option>New</option>
  <option>Follow Up</option>
  <option>Survey</option>
  <option>Closing</option>
</select>

<input type="date" id="next">

<textarea id="note" placeholder="Catatan follow up..."></textarea>

<button onclick="simpan()">Simpan Follow Up</button>

<ul id="history"></ul>

<script src="js/db.js"></script>
<script src="js/pipeline.js"></script>
<script>
const id = Number(new URLSearchParams(location.search).get("id"));

function load(){
  getLeads(data=>{
    const d = data.find(x=>x.id===id);

    status.value = d.status;
    next.value = d.nextFollow || "";
    history.innerHTML = "";

    if(d.nextFollow){
      history.innerHTML += `<li><b>Next FU:</b> ${d.nextFollow}</li>`;
    }

    d.catatan.slice().reverse().forEach(c=>{
      history.innerHTML += `<li>${c.tgl}<br>${c.text}</li>`;
    });
  });
}

function simpan(){
  if(!note.value && !next.value){
    alert("Isi catatan atau tanggal follow up");
    return;
  }

  const tx = db.transaction("leads","readwrite");
  const store = tx.objectStore("leads");
  const req = store.get(id);

  req.onsuccess = ()=>{
    const d = req.result;
    d.status = status.value;
    d.nextFollow = next.value;

    if(note.value){
      d.catatan.push({
        tgl: new Date().toLocaleString(),
        text: note.value
      });
    }

    store.put(d);
    note.value="";
    load();
  }
}

setTimeout(load,500);
</script>

</body>
</html>
