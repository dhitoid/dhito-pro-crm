<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Leads â€“ Dhito Pro CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/ui.css">
</head>
<body class="dark">

<script src="js/auth.js"></script>
<script>protect()</script>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">DHITO<br>CRM</div>

    <a href="dashboard.html">
      <span>ğŸ </span> Home
    </a>

    <a href="leads.html" class="active">
      <span>ğŸ“‡</span> Leads
    </a>

    <a href="followup.html">
      <span>ğŸ””</span> Follow
    </a>

    <div style="margin-top:auto;width:100%">
      <a href="#" onclick="logout()">
        <span>ğŸšª</span> Logout
      </a>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="container">

      <h2>Database Konsumen</h2>

      <!-- TAMBAH -->
      <div class="card">
        <h3>â• Tambah Konsumen</h3>
        <input id="nama" placeholder="Nama Konsumen">
        <input id="hp" placeholder="No HP">
        <button onclick="simpan()">Simpan</button>
      </div>

      <!-- EDIT -->
      <div id="editBox" class="card" style="display:none">
        <h3>âœï¸ Edit Konsumen</h3>
        <input id="editNama" placeholder="Nama">
        <input id="editHp" placeholder="No HP">
        <div style="display:flex;gap:10px">
          <button onclick="simpanEdit()">Simpan</button>
          <button class="ghost" onclick="batalEdit()">Batal</button>
        </div>
      </div>

      <!-- REMINDER -->
      <div class="card">
        <h3>ğŸ”” Follow Up Hari Ini</h3>
        <ul id="reminder"></ul>
      </div>

      <!-- LIST -->
      <div class="card">
        <h3>ğŸ“‡ Semua Konsumen</h3>
        <ul id="list"></ul>
      </div>

    </div>
  </main>

</div>

<script src="js/db.js"></script>
<script src="js/pipeline.js"></script>

<script>
/* ===============================
   STATUS FALLBACK (ANTI ERROR)
================================ */
const STATUS_COLOR = {
  "New":"#3b82f6",
  "Contacted":"#6366f1",
  "Interested":"#22c55e",
  "Survey":"#facc15",
  "Booking":"#f97316",
  "Deal":"#16a34a",
  "Not Interested":"#ef4444"
};

function statusColor(status){
  return STATUS_COLOR[status] || "#334155";
}

function statusBadge(status){
  if(!status) return "";
  return `<span class="badge" style="
    background:${statusColor(status)};
    color:#020617;
    font-weight:600
  ">${status}</span>`;
}

function isToday(date){
  if(!date) return false;
  const d = new Date(date).toISOString().slice(0,10);
  const t = new Date().toISOString().slice(0,10);
  return d === t;
}

let editId = null;

function editLead(id){
  editId = id;
  getLeads(data=>{
    const d = data.find(x=>x.id===id);
    editNama.value = d.nama;
    editHp.value = d.hp;
    editBox.style.display = "block";
    editBox.scrollIntoView({behavior:"smooth"});
  });
}

function batalEdit(){
  editBox.style.display = "none";
  editId = null;
}

function simpanEdit(){
  if(!editNama.value || !editHp.value){
    alert("Lengkapi data");
    return;
  }

  const tx = db.transaction("leads","readwrite");
  const store = tx.objectStore("leads");
  const req = store.get(editId);

  req.onsuccess = ()=>{
    const d = req.result;
    d.nama = editNama.value;
    d.hp = editHp.value;
    store.put(d);
    batalEdit();
    load();
  };
}

function hapusLead(id){
  if(!confirm("Hapus data ini?")) return;
  const tx = db.transaction("leads","readwrite");
  tx.objectStore("leads").delete(id);
  load();
}

function simpan(){
  if(!nama.value || !hp.value){
    alert("Lengkapi data");
    return;
  }

  addLead({
    nama: nama.value,
    hp: hp.value,
    status: "New",
    catatan: [],
    nextFollow: ""
  });

  nama.value = "";
  hp.value = "";
  load();
}

function load(){
  getLeads(data=>{
    reminder.innerHTML = "";
    list.innerHTML = "";

    const today = data.filter(d => isToday(d.nextFollow));
    const others = data.filter(d => !isToday(d.nextFollow));

    if(today.length === 0){
      reminder.innerHTML = "<li><i>Tidak ada follow up hari ini</i></li>";
    }

    if(others.length === 0){
      list.innerHTML = "<li><i>Belum ada data konsumen</i></li>";
    }

    today.forEach(d=>{
      reminder.innerHTML += `
        <li class="reminder">
          <b>${d.nama}</b><br>
          ${d.hp}<br>
          <span class="badge">TODAY</span><br>
          <a href="followup.html?id=${d.id}">Follow Up</a> |
          <a href="#" onclick="editLead(${d.id})">Edit</a> |
          <a href="#" onclick="hapusLead(${d.id})">Hapus</a>
        </li>
      `;
    });

others.forEach(d=>{
  list.innerHTML += `
    <li style="border-left:4px solid ${statusColor(d.status)}">
      <b>${d.nama}</b><br>
      ${d.hp}<br>
      ${statusBadge(d.status)}<br>
      ${d.nextFollow ? "<small>FU: "+d.nextFollow+"</small>" : ""}
      <br>
      <a href="followup.html?id=${d.id}">Follow Up</a> |
      <a href="#" onclick="editLead(${d.id})">Edit</a> |
      <a href="#" onclick="hapusLead(${d.id})">Hapus</a>
    </li>
  `;
});
  });
}

setTimeout(load,800);
</script>

</body>
</html>
