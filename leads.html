<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Leads â€“ Dhito Pro CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>
<body class="dark">

<script src="js/auth.js"></script>
<script>protect()</script>

<h2>Database Konsumen</h2>

<input id="nama" placeholder="Nama Konsumen">
<input id="hp" placeholder="No HP">
<button onclick="simpan()">Simpan</button>

<div id="editBox" class="card" style="display:none">
  <h3>Edit Konsumen</h3>
  <input id="editNama" placeholder="Nama">
  <input id="editHp" placeholder="No HP">
  <button onclick="simpanEdit()">Simpan</button>
  <button onclick="batalEdit()">Batal</button>
</div>

<h3>ðŸ”” Follow Up Hari Ini</h3>
<ul id="reminder"></ul>

<h3>ðŸ“‡ Semua Konsumen</h3>
<ul id="list"></ul>

<script src="js/db.js"></script>
<script src="js/pipeline.js"></script>

<script>
let editId = null;

function editLead(id){
  editId = id;
  getLeads(data=>{
    const d = data.find(x=>x.id===id);
    editNama.value = d.nama;
    editHp.value = d.hp;
    editBox.style.display = "block";
  });
}

function batalEdit(){
  editBox.style.display = "none";
  editId = null;
}

function simpanEdit(){
  if(!editNama.value || !editHp.value){
    alert("Lengkapi data");
    return;
  }

  const tx = db.transaction("leads","readwrite");
  const store = tx.objectStore("leads");
  const req = store.get(editId);

  req.onsuccess = ()=>{
    const d = req.result;
    d.nama = editNama.value;
    d.hp = editHp.value;
    store.put(d);
    batalEdit();
    load();
  };
}

function hapusLead(id){
  if(!confirm("Hapus data ini?")) return;
  const tx = db.transaction("leads","readwrite");
  tx.objectStore("leads").delete(id);
  load();
}

function simpan(){
  addLead({
    nama: nama.value,
    hp: hp.value,
    status: "New",
    catatan: [],
    nextFollow: ""
  });

  nama.value = "";
  hp.value = "";
  load();
}

function load(){
  getLeads(data=>{
    reminder.innerHTML = "";
    list.innerHTML = "";

    const today = data.filter(d => isToday(d.nextFollow));
    const others = data.filter(d => !isToday(d.nextFollow));

if(today.length === 0){
  reminder.innerHTML = "<li><i>Tidak ada follow up hari ini</i></li>";
}

if(others.length === 0){
  list.innerHTML = "<li><i>Belum ada data konsumen</i></li>";
}

    today.forEach(d=>{
      reminder.innerHTML += `
        <li class="reminder">
          <b>${d.nama}</b><br>
          ${d.hp}<br>
          <span class="badge">TODAY</span><br>
          <a href="followup.html?id=${d.id}">Follow Up</a> |
<a href="#" onclick="editLead(${d.id})">Edit</a> |
<a href="#" onclick="hapusLead(${d.id})">Hapus</a>
        </li>
      `;
    });

    others.forEach(d=>{
      list.innerHTML += `
        <li style="border-left:4px solid ${statusColor(d.status)}">
          <b>${d.nama}</b><br>
          ${d.hp}<br>
          <small>Status: ${d.status}</small><br>
          ${d.nextFollow ? "FU: "+d.nextFollow : ""}
          <br>
         <a href="followup.html?id=${d.id}">Follow Up</a> |
<a href="#" onclick="editLead(${d.id})">Edit</a> |
<a href="#" onclick="hapusLead(${d.id})">Hapus</a>
        </li>
      `;
    });
  });
}
setTimeout(load,800);
</script>

</body>
</html>
