<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Leads â€“ Dhito Pro CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/ui.css">
</head>
<body class="dark">

<script src="js/auth.js"></script>
<script src="js/db.js"></script>
<script src="js/pipeline.js"></script>
<script>protect()</script>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">DHITO<br>CRM</div>

    <a href="dashboard.html">
      <span>ğŸ </span> Home
    </a>

    <a href="leads.html" class="active">
      <span>ğŸ“‡</span> Leads
    </a>

    <a href="followup.html">
      <span>ğŸ””</span> Follow
    </a>

    <div style="margin-top:auto;width:100%">
      <a href="#" onclick="logout()">
        <span>ğŸšª</span> Logout
      </a>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="container">

      <h2>Database Konsumen</h2>

      <!-- TAMBAH -->
      <div class="card">
        <h3>â• Tambah Konsumen</h3>
        <input id="nama" placeholder="Nama Konsumen">
        <input id="hp" placeholder="No HP">
        <button onclick="simpan()">Simpan</button>
      </div>

      <!-- EDIT -->
      <div id="editBox" class="card" style="display:none">
        <h3>âœï¸ Edit Konsumen</h3>
        <input id="editNama" placeholder="Nama">
        <input id="editHp" placeholder="No HP">
        <div style="display:flex;gap:10px">
          <button onclick="simpanEdit()">Simpan</button>
          <button class="ghost" onclick="batalEdit()">Batal</button>
        </div>
      </div>

      <!-- REMINDER -->
      <div class="card">
        <h3>ğŸ”” Follow Up Hari Ini</h3>
        <ul id="reminder"></ul>
      </div>

      <!-- LIST -->
      <div class="card">
        <h3>ğŸ“‡ Semua Konsumen</h3>
        <ul id="list"></ul>
      </div>

    </div>
  </main>

</div>

<script>
let editId = null;

/* ===============================
   LOAD DATA
================================ */
function load(){
  getLeads(data=>{
    reminder.innerHTML = "";
    list.innerHTML = "";

    const today = data.filter(d => isToday(d.nextFollow));
    const others = data.filter(d => !isToday(d.nextFollow));

    if(today.length === 0){
      reminder.innerHTML = "<li><i>Tidak ada follow up hari ini</i></li>";
    }

    if(others.length === 0){
      list.innerHTML = "<li><i>Belum ada data konsumen</i></li>";
    }

today.forEach(d=>{
  d.status = normalizeStatus(d.status);
  reminder.innerHTML += `
    <li style="border-left:4px solid ${statusColor(d.status)}">
      <b>${d.nama}</b><br>
      ${d.hp}<br>
      ${statusBadge(d.status)}<br>
      <small>FU: ${d.nextFollow}</small><br>
      <a href="followup.html?id=${d.id}">Follow Up</a> |
      <a href="#" onclick="editLead(${d.id})">Edit</a> |
      <a href="#" onclick="hapusLead(${d.id})">Hapus</a>
    </li>
  `;
});

    others.forEach(d=>{
      d.status = normalizeStatus(d.status);
      list.innerHTML += `
        <li style="border-left:4px solid ${statusColor(d.status)}">
          <b>${d.nama}</b><br>
          ${d.hp}<br>
          ${statusBadge(d.status)}<br>
          ${d.nextFollow ? `<small>FU: ${d.nextFollow}</small>` : ""}
          <br>
          <a href="followup.html?id=${d.id}">Follow Up</a> |
          <a href="#" onclick="editLead(${d.id})">Edit</a> |
          <a href="#" onclick="hapusLead(${d.id})">Hapus</a>
        </li>
      `;
    });
  });
}

/* ===============================
   CRUD
================================ */
function simpan(){
  if(!nama.value || !hp.value){
    alert("Lengkapi data");
    return;
  }

  addLead({
    nama: nama.value,
    hp: hp.value,
    status: "New",
    catatan: [],
    nextFollow: ""
  }, () => {
    nama.value = "";
    hp.value = "";
    load(); // DIPANGGIL SETELAH TX SELESAI
  });
}

function editLead(id){
  editId = id;
  getLeads(data=>{
    const d = data.find(x=>x.id===id);
    editNama.value = d.nama;
    editHp.value = d.hp;
    editBox.style.display = "block";
  });
}

function simpanEdit(){
  const tx = db.transaction("leads","readwrite");
  const store = tx.objectStore("leads");
  const req = store.get(editId);

  req.onsuccess = ()=>{
    const d = req.result;
    d.nama = editNama.value;
    d.hp = editHp.value;
    store.put(d);
    editBox.style.display = "none";
    load();
  };
}

function hapusLead(id){
  if(!confirm("Hapus data?")) return;
  db.transaction("leads","readwrite")
    .objectStore("leads")
    .delete(id);
  load();
}

/* ===============================
   INIT
================================ */
protect(); // auth dulu

document.addEventListener("DOMContentLoaded", ()=>{
  openDB(() => {
    load();
  });
});
</script>

</body>
</html>
